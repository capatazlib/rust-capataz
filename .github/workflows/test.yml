name: "Tests"
on:
  pull_request:
  push:
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.1
      - uses: cachix/install-nix-action@v10
      - uses: cachix/cachix-action@v6
        with:
          name: capatazlib
          signingKey: '${{ secrets.CACHIX_SIGNING_KEY }}'

      - name: Execute Tests on stable
        # the ci-stable nix build already runs the test-suite on success (maximum cache)
        run: nix-shell ci-stable.nix --run 'echo tests done'

      - name: Execute Linters
        run: nix-shell ci-stable.nix --run 'make lint'

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.1
      - uses: cachix/install-nix-action@v10
      - uses: cachix/cachix-action@v6
        with:
          name: capatazlib
          signingKey: '${{ secrets.CACHIX_SIGNING_KEY }}'

      - name: Execute Coverage Check
        # sadly, coverage can only be executed with nightly
        run: nix-shell ci-nightly.nix --run 'make coverage'

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: '${{ secrets.CODECOV_TOKEN }}'
          file: ./target/lcov.info
